<ng-template #dataTypesTemplate let-isDesktop="isDesktop">
  <div class="p-4 border-b border-gray-200 dark:border-zinc-700">
    <h2 class="text-lg font-semibold textNormal">Data Types</h2>
  </div>
  <div
    [class]="
      isDesktop
        ? 'flex flex-col gap-y-1 p-3'
        : 'flex flex-col gap-y-1 p-3 divide-y divide-gray-100 dark:divide-zinc-700 max-h-[calc(100vh-200px)] lg:max-h-none overflow-y-auto'
    "
  >
    @for (type of dataTypes; track type.id) {
      <button
        class="flex flex-row gap-x-2 styleFloatBut w-full"
        [class.bg-gray-300]="isDesktop && selectedType() === type.id"
        [class.dark:bg-zinc-700]="isDesktop && selectedType() === type.id"
        (click)="selectDataType(type.id)"
      >
        <mat-icon class="w-5! h-5! text-xl!" [fontIcon]="type.icon" />
        <div [class]="isDesktop ? 'flex flex-col flex-1 items-start' : 'flex-1'">
          <div class="text-sm font-medium textNormal">{{ type.label }}</div>
          <div class="flex items-center justify-between mt-1">
            <span class="text-xs textMuted">{{ type.count }} items</span>
          </div>
        </div>
        <div class="flex flex-row gap-x-1">
          @if (loading()) {
            <mat-icon class="w-5! h-5! text-xl! text-blue-500 animate-spin" fontIcon="sync" />
          }
          <mat-icon
            class="w-5! h-5! text-xl! textMuted"
            [class.rotate-90]="!isDesktop && selectedType() === type.id"
            fontIcon="chevron_right"
          />
        </div>
      </button>
    }
  </div>
</ng-template>

<ng-template #filtersTemplate let-isMobile="isMobile">
  @if (isMobile) {
    <div
      class="flex flex-row items-center justify-between p-4 border-b border-gray-200 dark:border-zinc-700"
    >
      <h2 class="text-lg font-semibold textNormal">Advanced Filters</h2>
      <button mat-button class="min-w-0! w-9! h-9! p-0!" (click)="closeFilters()">
        <mat-icon class="w-5! h-5! text-xl!" fontIcon="close" />
      </button>
    </div>
  } @else {
    <div class="p-4 border-b border-gray-200 dark:border-zinc-700">
      <h2 class="text-lg font-semibold textNormal">Advanced Filters</h2>
    </div>
  }
  <div class="flex flex-col gap-y-1 p-3">
    <mat-form-field class="w-full">
      <mat-label>Search Title</mat-label>
      <input
        matInput
        [ngModel]="titleFilter()"
        (ngModelChange)="titleFilter.set($event)"
        placeholder="Search by title..."
      />
    </mat-form-field>
    @if (
      selectedType() === "todos" || selectedType() === "tasks" || selectedType() === "subtasks"
    ) {
      <mat-form-field class="w-full">
        <mat-label>Priority</mat-label>
        <mat-select [ngModel]="priorityFilter()" (ngModelChange)="priorityFilter.set($event)">
          <mat-option value="">All</mat-option>
          <mat-option value="low">Low</mat-option>
          <mat-option value="medium">Medium</mat-option>
          <mat-option value="high">High</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field class="w-full">
        <mat-label>Completion Status</mat-label>
        <mat-select [ngModel]="isCompletedFilter()" (ngModelChange)="isCompletedFilter.set($event)">
          <mat-option value="all">All</mat-option>
          <mat-option value="completed">Completed</mat-option>
          <mat-option value="pending">Pending</mat-option>
        </mat-select>
      </mat-form-field>
    }
    @if (selectedType() === "todos") {
      <mat-form-field class="w-full">
        <mat-label>Categories</mat-label>
        <input
          matInput
          [ngModel]="categoriesFilter()"
          (ngModelChange)="categoriesFilter.set($event)"
          placeholder="Search by categories..."
        />
      </mat-form-field>
    }
    @if (selectedType() === "todos" || selectedType() === "categories") {
      <mat-form-field class="w-full">
        <mat-label>User</mat-label>
        <input
          matInput
          [ngModel]="userFilter()"
          (ngModelChange)="userFilter.set($event)"
          placeholder="Search by user..."
        />
      </mat-form-field>
    }
    @if (selectedType() === "tasks") {
      <mat-form-field class="w-full">
        <mat-label>Todo ID</mat-label>
        <input
          matInput
          [ngModel]="todoIdFilter()"
          (ngModelChange)="todoIdFilter.set($event)"
          placeholder="Search by todo ID..."
        />
      </mat-form-field>
    }
    @if (selectedType() === "subtasks") {
      <mat-form-field class="w-full">
        <mat-label>Task ID</mat-label>
        <input
          matInput
          [ngModel]="taskIdFilter()"
          (ngModelChange)="taskIdFilter.set($event)"
          placeholder="Search by task ID..."
        />
      </mat-form-field>
    }

    @if (
      selectedType() === "categories" ||
      selectedType() === "tasks" ||
      selectedType() === "todos" ||
      selectedType() === "subtasks"
    ) {
      <mat-form-field class="w-full">
        <mat-label>Status</mat-label>
        <mat-select [ngModel]="statusFilter()" (ngModelChange)="statusFilter.set($event)">
          <mat-option value="all">All Records</mat-option>
          <mat-option value="active">Active Only</mat-option>
          <mat-option value="deleted">Deleted Only</mat-option>
        </mat-select>
      </mat-form-field>
    }
    @if (
      selectedType() === "tasks" || selectedType() === "todos" || selectedType() === "categories"
    ) {
      <mat-form-field class="w-full">
        <mat-label>Start Date From</mat-label>
        <input
          matInput
          [matDatepicker]="picker1"
          [ngModel]="startDateFilter()"
          (ngModelChange)="startDateFilter.set($event)"
        />
        <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
        <mat-datepicker #picker1></mat-datepicker>
      </mat-form-field>
      <mat-form-field class="w-full">
        <mat-label>End Date To</mat-label>
        <input
          matInput
          [matDatepicker]="picker2"
          [ngModel]="endDateFilter()"
          (ngModelChange)="endDateFilter.set($event)"
        />
        <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
        <mat-datepicker #picker2></mat-datepicker>
      </mat-form-field>
    }
  </div>
</ng-template>

<div class="flex flex-col gap-4 lg:gap-8">
  <div class="flex flex-wrap gap-2">
    @for (type of dataTypes; track type.id) {
      <button
        class="px-4 py-2 rounded-lg transition-colors font-medium"
        [ngClass]="
          selectedType() === type.id
            ? 'bg-blue-500 text-white'
            : 'bg-gray-200 dark:bg-zinc-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-zinc-600'
        "
        (click)="selectDataType(type.id)"
      >
        <div class="flex items-center gap-2">
          <mat-icon class="w-5! h-5! text-xl!" [fontIcon]="type.icon" />
          <span>{{ type.label }} ({{ type.count }})</span>
        </div>
      </button>
    }
  </div>

  <div class="h-[calc(100vh-220px)] overflow-y-auto">
    <div
      class="bg-white dark:bg-zinc-800 rounded-xl shadow-lg border border-gray-200 dark:border-zinc-700"
    >
      <div class="p-4 lg:p-6 border-b border-gray-200 dark:border-zinc-700">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
          <div>
            <h2 class="text-xl font-bold textNormal">{{ getSelectedTypeLabel() }}</h2>
            <p class="text-sm textMuted">{{ getCurrentData().length }} total records</p>
          </div>
          <div class="flex flex-row gap-2 items-center flex-wrap">
            <label class="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                class="styleCheckbox"
                [checked]="isAllSelected()"
                [indeterminate]="selectedRecords().size > 0 && !isAllSelected()"
                (change)="toggleSelectAll()"
              />
              <span class="text-sm font-medium">Select All</span>
            </label>
            <mat-form-field class="w-32">
              <mat-label>Sort By</mat-label>
              <mat-select [ngModel]="sortBy()" (ngModelChange)="sortBy.set($event)">
                <mat-option value="createdAt">Created Date</mat-option>
                <mat-option value="updatedAt">Updated Date</mat-option>
                <mat-option value="title">Title</mat-option>
                @if (
                  selectedType() === "todos" ||
                  selectedType() === "tasks" ||
                  selectedType() === "subtasks"
                ) {
                  <mat-option value="priority">Priority</mat-option>
                }
                @if (selectedType() === "todos" || selectedType() === "tasks") {
                  <mat-option value="startDate">Start Date</mat-option>
                  <mat-option value="endDate">End Date</mat-option>
                }
              </mat-select>
            </mat-form-field>
            <button
              class="styleButInfo"
              (click)="sortOrder.set(sortOrder() === 'asc' ? 'desc' : 'asc')"
            >
              <mat-icon
                class="w-5! h-5! text-xl!"
                [fontIcon]="sortOrder() === 'asc' ? 'arrow_upward' : 'arrow_downward'"
              />
            </button>
            <button class="styleButInfo" (click)="loadAdminData()" [disabled]="loading()">
              <mat-icon
                class="w-5! h-5! text-xl! mr-2"
                [ngClass]="loading() ? 'animate-spin' : ''"
                fontIcon="sync"
              />
              Refresh
            </button>
            <button
              class="styleButDanger"
              [disabled]="selectedRecords().size === 0"
              (click)="deleteSelected()"
            >
              <mat-icon class="w-5! h-5! text-xl! mr-2" fontIcon="delete_forever" />
              Delete Selected ({{ selectedRecords().size }})
            </button>
            <button class="styleButInfo" (click)="showFilters.set(!showFilters())">
              <mat-icon class="w-5! h-5! text-xl! mr-2" fontIcon="filter_alt" />
              Filters
            </button>
          </div>
        </div>
      </div>

      <div class="p-4 lg:p-6">
        @if (loading()) {
          <div class="flex items-center justify-center py-16">
            <mat-icon class="w-7.5! h-7.5! text-3xl! text-blue-500 animate-spin" fontIcon="sync" />
            <span class="ml-3 textNormal">Loading data...</span>
          </div>
        } @else if (getCurrentData().length === 0) {
          <div class="text-center py-16">
            <mat-icon class="w-16! h-16! text-4xl! text-gray-300" fontIcon="inbox" />
            <h3 class="text-lg font-medium text-gray-500">No records found</h3>
            <p class="mt-2 text-sm textMuted">
              No {{ getSelectedTypeLabel().toLowerCase() }} data available
            </p>
          </div>
        } @else {
          @switch (selectedType()) {
            @case ("todos") {
              <app-todo-records
                [todos]="getCurrentData()"
                [selectedRecords]="selectedRecords()"
                (selectRecord)="toggleSelect($event)"
                (deleteRecord)="deleteRecord($event)"
              />
            }
            @case ("tasks") {
              <app-task-records
                [tasks]="getCurrentData()"
                [selectedRecords]="selectedRecords()"
                (selectRecord)="toggleSelect($event)"
                (deleteRecord)="deleteRecord($event)"
              />
            }
            @case ("subtasks") {
              <app-subtask-records
                [subtasks]="getCurrentData()"
                [selectedRecords]="selectedRecords()"
                (selectRecord)="toggleSelect($event)"
                (deleteRecord)="deleteRecord($event)"
              />
            }
            @case ("categories") {
              <app-category-records
                [categories]="getCurrentData()"
                [selectedRecords]="selectedRecords()"
                (selectRecord)="toggleSelect($event)"
                (deleteRecord)="deleteRecord($event)"
              />
            }
            @case ("daily_activities") {
              <app-daily-activity-records
                [records]="getCurrentData()"
                [selectedRecords]="selectedRecords()"
                (selectRecord)="toggleSelect($event)"
                (deleteRecord)="deleteRecord($event)"
              />
            }
            @default {
              <app-daily-activity-records
                [records]="getCurrentData()"
                [selectedRecords]="selectedRecords()"
                (selectRecord)="toggleSelect($event)"
                (deleteRecord)="deleteRecord($event)"
              />
            }
          }
        }
      </div>
    </div>
  </div>

  <div
    class="fixed flex-col top-0 right-0 z-40 bg-white dark:bg-zinc-800 rounded-xl shadow-lg border border-gray-200 dark:border-zinc-700 overflow-y-auto max-w-sm h-full lg:max-w-none"
    [class.flex]="showFilters()"
    [class.hidden]="!showFilters()"
  >
    <ng-container *ngTemplateOutlet="filtersTemplate; context: { isMobile: false }" />
  </div>
  @if (showFilters()) {
    <div class="fixed inset-0 z-30 bg-black/50" (click)="closeFilters()"></div>
  }
</div>
