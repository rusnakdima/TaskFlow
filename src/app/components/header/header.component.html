<div
  class="sticky top-0 z-40 bg-white dark:bg-zinc-900 border-b border-gray-200 dark:border-zinc-700 shadow-sm"
>
  <div class="flex items-center justify-between px-4 py-3 max-w-7xl mx-auto">
    <div class="flex items-center gap-3">
      @if (isBack()) {
        <button
          class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-800 h-9! transition-colors"
          (click)="goBack()"
        >
          <mat-icon class="size-5! text-xl! textNormal" fontIcon="arrow_back" />
        </button>
      }

      <div class="flex flex-col">
        <h1 class="text-lg font-semibold textNormal">{{ title() }}</h1>
        @if (description()) {
          <p class="text-sm textMuted">{{ description() }}</p>
        }
      </div>
    </div>

    <div class="flex items-center gap-2">
      <button
        class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-800 transition-colors h-9! relative"
        title="Notifications"
        [matMenuTriggerFor]="notificationMenu"
      >
        <mat-icon class="w-6! h-6! text-2xl! textMuted" fontIcon="notifications_none" />
        @if (unreadCount() > 0) {
          <div
            class="absolute -top-1 -right-1 min-w-4 h-4 px-1 bg-red-500 rounded-full text-[10px] text-white flex items-center justify-center font-bold"
          >
            {{ unreadCount() > 9 ? "9+" : unreadCount() }}
          </div>
        }
      </button>

      <button
        class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-800 h-9! transition-colors"
        (click)="syncAll()"
        [disabled]="isSyncing()"
        [title]="isSyncing() ? 'Synchronizing...' : 'Sync data with cloud'"
      >
        <mat-icon
          class="w-6! h-6! text-2xl! textMuted"
          [ngClass]="isSyncing() ? 'animate-spin' : ''"
          fontIcon="sync"
        />
      </button>

      <button
        class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-800 h-9! transition-colors"
        (click)="toggleTheme()"
        [title]="themeVal() === 'dark' ? 'Switch to light mode' : 'Switch to dark mode'"
      >
        <mat-icon
          class="w-6! h-6! text-2xl! textMuted"
          [fontIcon]="themeVal() === 'dark' ? 'light_mode' : 'dark_mode'"
        />
      </button>

      <button
        class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-800 transition-colors"
        [matMenuTriggerFor]="userMenu"
      >
        <img
          [src]="profile()?.imageUrl ? profile()!.imageUrl : 'assets/images/user.png'"
          class="w-8 min-w-8 h-8 rounded-full"
          alt=""
        />
      </button>
    </div>
  </div>
</div>

<mat-menu #userMenu="matMenu" xPosition="before" class="min-w-[200px]! max-w-[300px]!">
  <div
    class="p-3 border-b border-gray-200 dark:border-zinc-700 outline-none"
    (click)="$event.stopPropagation()"
  >
    <p class="font-medium textNormal">
      {{ profile() ? profile()!.name : "User" }} {{ profile() ? profile()!.lastName : "" }}
    </p>
    <p class="text-sm textMuted">{{ profile() ? profile()!.user.email : "" }}</p>
  </div>

  <div class="py-2">
    <button
      mat-menu-item
      routerLink="/profile"
      [queryParams]="{ id: userId() }"
      class="hover:bg-gray-300! dark:hover:bg-zinc-700! transition-colors"
    >
      <mat-icon class="size-5! text-xl! textMuted mr-3" fontIcon="person" />
      <span class="textNormal">Profile</span>
    </button>

    <button
      mat-menu-item
      routerLink="/categories"
      class="hover:bg-gray-300! dark:hover:bg-zinc-700! transition-colors"
    >
      <mat-icon class="size-5! text-xl! textMuted mr-3" fontIcon="category" />
      <span class="textNormal">Categories</span>
    </button>

    <button
      mat-menu-item
      routerLink="/sync"
      class="hover:bg-gray-300! dark:hover:bg-zinc-700! transition-colors"
    >
      <mat-icon class="size-5! text-xl! textMuted mr-3" fontIcon="sync" />
      <span class="textNormal">Sync Data</span>
    </button>

    @if (role() == "admin") {
      <button
        mat-menu-item
        routerLink="/admin"
        class="hover:bg-gray-300! dark:hover:bg-zinc-700! transition-colors"
      >
        <mat-icon class="size-5! text-xl! textMuted mr-3" fontIcon="manage_accounts" />
        <span class="textNormal">Admin</span>
      </button>
    }

    <button
      mat-menu-item
      routerLink="/about"
      class="hover:bg-gray-300! dark:hover:bg-zinc-700! transition-colors"
    >
      <mat-icon class="size-5! before:w-5! text-xl! textMuted mr-3" fontIcon="info_outlined" />
      <span class="textNormal">About</span>
    </button>

    <hr class="my-2 border-gray-200 dark:border-zinc-700" />

    <button
      mat-menu-item
      class="text-red-600 dark:text-red-400 hover:bg-red-50! dark:hover:bg-red-900/30! transition-colors"
      (click)="logout()"
    >
      <mat-icon class="size-5! text-xl! mr-3 text-red-600 dark:text-red-400" fontIcon="logout" />
      <span>Sign out</span>
    </button>
  </div>
</mat-menu>

<mat-menu #notificationMenu="matMenu" xPosition="before" class="min-w-[320px]! max-w-[320px]!">
  <div class="w-80 max-h-[400px] flex flex-col outline-none" (click)="$event.stopPropagation()">
    <div
      class="p-3 border-b border-gray-200 dark:border-zinc-700 flex items-center justify-between sticky top-0 bg-white dark:bg-zinc-800 z-10"
    >
      <h3 class="font-semibold textNormal">Notifications</h3>
      <div class="flex gap-2">
        @if (unreadCount() > 0) {
          <button
            class="text-xs text-blue-600 dark:text-blue-400 hover:underline"
            (click)="markAllAsRead()"
          >
            Mark all read
          </button>
        }
        <button
          class="text-xs text-red-600 dark:text-red-400 hover:underline"
          (click)="clearNotifications()"
        >
          Clear
        </button>
      </div>
    </div>

    <div class="overflow-y-auto flex-1 max-h-[350px]">
      @if (notifications().length === 0) {
        <div class="p-8 text-center">
          <mat-icon class="size-12! text-4xl! textMuted mb-2" fontIcon="notifications_off" />
          <p class="textMuted text-sm">No notifications yet</p>
        </div>
      } @else {
        <div class="flex flex-col">
          @for (notif of notifications(); track notif.id) {
            <div
              class="p-3 border-b border-gray-100 dark:border-zinc-700/50 last:border-0 hover:bg-gray-50 dark:hover:bg-zinc-700/30 transition-colors relative group"
              [ngClass]="!notif.read ? 'bg-blue-50/30 dark:bg-blue-900/10' : ''"
            >
              <div class="flex gap-3">
                <div
                  class="w-8 h-8 rounded-full flex items-center justify-center shrink-0"
                  [ngClass]="{
                    'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400':
                      notif.type === 'todo',
                    'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400':
                      notif.type === 'task',
                    'bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400':
                      notif.type === 'subtask',
                  }"
                >
                  <mat-icon
                    class="size-5! text-xl!"
                    [fontIcon]="
                      notif.type === 'todo'
                        ? 'assignment'
                        : notif.type === 'task'
                          ? 'task_alt'
                          : 'subdirectory_arrow_right'
                    "
                  />
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium textNormal truncate">{{ notif.title }}</p>
                  <p class="text-xs textMuted line-clamp-2">{{ notif.message }}</p>
                  <p class="text-[10px] textMuted mt-1">
                    {{ notif.timestamp | date: "shortTime" }}
                  </p>
                </div>
                @if (!notif.read) {
                  <button
                    class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity"
                    (click)="markAsRead(notif.id)"
                    title="Mark as read"
                  >
                    <mat-icon class="size-5! text-xl! text-blue-500!" fontIcon="check_circle" />
                  </button>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>
</mat-menu>
