@if (task) {
  <div cdkDrag class="h-full flex flex-col" [class.expanded]="isExpanded">
    <div
      class="flex flex-col grow p-6 rounded-xl border border-gray-200 dark:border-zinc-700 bg-white dark:bg-zinc-800 min-h-full box-border shadow-lg hover:shadow-xl transition-all duration-200 group cursor-pointer"
      [ngClass]="{ 'ring-4 ring-green-500 animate-pulse': highlight }"
      [routerLink]="!isExpanded ? [task.id + '/subtasks'] : []"
      [queryParams]="!isExpanded ? { isOwner: isOwner, isPrivate: isPrivate } : null"
    >
      <div class="flex flex-col grow">
        <div class="flex flex-row items-start justify-between mb-4">
          <div class="flex flex-row flex-1 items-start gap-3">
            <button
              class="p-1 rounded hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors"
              (click)="toggleCompletion($event)"
              [title]="
                task.status === 'completed'
                  ? 'Mark as skipped'
                  : task.status === 'skipped'
                    ? 'Mark as failed'
                    : task.status === 'failed'
                      ? 'Mark as pending'
                      : 'Mark as completed'
              "
            >
              @if (task.status === "completed") {
                <mat-icon class="w-5! h-5! text-xl! text-green-600!" fontIcon="check_circle" />
              } @else if (task.status === "skipped") {
                <mat-icon
                  class="w-5! h-5! text-xl! text-orange-600! dark:text-orange-400!"
                  fontIcon="cancel"
                />
              } @else if (task.status === "failed") {
                <mat-icon
                  class="w-5! h-5! text-xl! text-red-600! dark:text-red-400!"
                  fontIcon="dangerous"
                />
              } @else {
                <mat-icon
                  class="w-5! h-5! text-xl! text-gray-400 hover:text-green-600 dark:hover:text-green-400 transition-colors"
                  fontIcon="radio_button_unchecked"
                />
              }
            </button>

            <div class="flex-1 min-w-0 cursor-pointer">
              @if (editingField() === "title") {
                <input
                  type="text"
                  [ngModel]="editingValue()"
                  (ngModelChange)="editingValue.set($event)"
                  (blur)="saveInlineEdit()"
                  (keyup.enter)="saveInlineEdit()"
                  (keyup.escape)="cancelInlineEdit()"
                  class="w-full px-2 py-1 text-lg font-semibold bg-transparent border-b-2 border-green-500 focus:outline-none textNormal"
                  (click)="$event.stopPropagation()"
                />
              } @else {
                <h3
                  class="text-lg font-semibold textNormal"
                  [ngClass]="
                    task.status === 'completed' ||
                    task.status === 'skipped' ||
                    task.status === 'failed'
                      ? 'line-through text-gray-500 dark:text-gray-400'
                      : 'group-hover:text-green-600 dark:group-hover:text-green-400'
                  "
                  (dblclick)="startInlineEdit('title', task.title || '')"
                  title="Double-click to edit title"
                  (click)="$event.stopPropagation()"
                >
                  {{ task.title }}
                </h3>
              }

              @if (editingField() === "description") {
                <textarea
                  [ngModel]="editingValue()"
                  (ngModelChange)="editingValue.set($event)"
                  (blur)="saveInlineEdit()"
                  (keyup.enter)="saveInlineEdit()"
                  (keyup.escape)="cancelInlineEdit()"
                  class="w-full px-2 py-1 text-sm bg-transparent border border-green-500 rounded focus:outline-none textNormal resize-none"
                  rows="2"
                  (click)="$event.stopPropagation()"
                ></textarea>
              } @else if (task.description && task.description != "") {
                <p
                  class="text-sm textMuted line-clamp-2"
                  (dblclick)="startInlineEdit('description', task.description)"
                  title="Double-click to edit description"
                  (click)="$event.stopPropagation()"
                >
                  {{ truncateString(task.description, 100) }}
                </p>
              }
            </div>
          </div>

          <div class="flex items-center gap-2 ml-2">
            <span
              class="px-2 py-1 rounded-full text-xs font-medium"
              [ngClass]="getPriorityColor(task.priority || 'medium')"
            >
              {{ (task.priority || "medium").toUpperCase() }}
            </span>
          </div>
        </div>

        <div class="flex items-center gap-4 mb-4 text-sm textMuted">
          @if (task.endDate) {
            <div class="flex items-center gap-1">
              <mat-icon class="w-5! h-5! text-xl!" fontIcon="schedule" />
              <span>Due {{ formatDate(task.endDate) }}</span>
            </div>
          }
          <div class="flex items-center gap-1">
            <mat-icon class="w-5! h-5! text-xl!" fontIcon="list" />
            <span>{{ totalSubtasks }} subtasks</span>
          </div>
          @if (totalSubtasks > 0) {
            <div class="flex items-center gap-1">
              <mat-icon class="w-5! h-5! text-xl!" fontIcon="check_circle" />
              <span>{{ countCompletedSubtasks }}/{{ totalSubtasks }}</span>
            </div>
          }
        </div>

        <div class="mb-4">
          <div class="flex justify-between text-sm mb-2">
            <span class="textMuted">Progress</span>
            <span class="textNormal font-medium">{{ getProgressPercentage() }}%</span>
          </div>
          <div class="w-full bg-gray-200 dark:bg-zinc-700 rounded-full h-3 overflow-hidden">
            <div class="flex h-full rounded-full overflow-hidden">
              @for (segment of getProgressSegments(); track segment.status) {
                <div
                  class="h-full transition-all duration-300"
                  [ngClass]="segment.color"
                  [style.width.%]="segment.percentage"
                  [title]="segment.status + ': ' + segment.percentage + '%'"
                ></div>
              }
            </div>
          </div>
          <div class="flex justify-between text-xs mt-1 textMuted">
            @for (segment of getProgressSegments(); track segment.status) {
              <span
                class="flex items-center gap-1"
                [title]="segment.status + ': ' + segment.percentage + '%'"
              >
                <div class="w-2 h-2 rounded-full" [ngClass]="segment.color"></div>
                {{ segment.percentage }}%
              </span>
            }
          </div>
        </div>

        @if (isExpanded && subtasks.length > 0) {
          <div class="border-t border-gray-200 dark:border-zinc-700 pt-4 mt-2">
            <h4 class="text-sm font-medium textMuted mb-3 flex items-center gap-2">
              <mat-icon class="w-4! h-4! text-xl!" fontIcon="list" />
              Subtasks
            </h4>
            <div class="flex flex-col gap-2 max-h-64 overflow-y-auto">
              @for (subtask of subtasks; track subtask.id) {
                <div
                  class="flex items-center gap-3 p-3 rounded-lg bg-gray-50 dark:bg-zinc-900/50 hover:bg-gray-100 dark:hover:bg-zinc-900 transition-colors"
                >
                  <button
                    class="p-0.5 rounded hover:bg-gray-200 dark:hover:bg-zinc-700 transition-colors"
                    (click)="onSubtaskToggleCompletion(subtask)"
                  >
                    <mat-icon
                      class="w-5! h-5! text-xl!"
                      [fontIcon]="getSubtaskStatusIcon(subtask.status)"
                      [ngClass]="getSubtaskStatusColor(subtask.status)"
                    />
                  </button>
                  <div class="flex-1 min-w-0">
                    <p
                      class="text-sm font-medium truncate"
                      [ngClass]="
                        subtask.status === 'completed' ||
                        subtask.status === 'skipped' ||
                        subtask.status === 'failed'
                          ? 'line-through text-gray-500 dark:text-gray-400'
                          : 'textNormal'
                      "
                    >
                      {{ subtask.title }}
                    </p>
                  </div>
                  <span
                    class="px-2 py-0.5 rounded-full text-xs font-medium"
                    [ngClass]="getSubtaskPriorityColor(subtask.priority || 'medium')"
                  >
                    {{ (subtask.priority || "medium").toUpperCase() }}
                  </span>
                </div>
              }
            </div>
          </div>
        }
      </div>

      <div class="flex items-center justify-between mt-auto pt-4">
        <div class="flex gap-2">
          <button
            class="px-3 py-1 text-xs font-medium rounded-full transition-colors"
            [ngClass]="
              task.status === 'completed'
                ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300'
                : task.status === 'skipped'
                  ? 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300'
                  : task.status === 'failed'
                    ? 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300'
                    : 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300'
            "
          >
            {{
              task.status === "completed"
                ? "Completed"
                : task.status === "skipped"
                  ? "Skipped"
                  : task.status === "failed"
                    ? "Failed"
                    : "In Progress"
            }}
          </button>
        </div>

        <div class="flex flex-row gap-2" (click)="$event.stopPropagation()">
          <button
            class="p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-900/30 text-gray-600 dark:text-gray-400 transition-colors cursor-move"
            cdkDragHandle
            title="Drag to reorder"
          >
            <mat-icon class="w-5! h-5! text-xl!" fontIcon="drag_indicator" />
          </button>

          <button
            class="p-2 rounded-lg transition-colors"
            [ngClass]="
              isExpanded
                ? 'bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400'
                : 'hover:bg-gray-50 dark:hover:bg-gray-900/30 text-gray-600 dark:text-gray-400'
            "
            (click)="toggleExpand()"
            [title]="isExpanded ? 'Collapse subtasks' : 'Expand subtasks'"
          >
            <mat-icon
              class="w-5! h-5! text-xl!"
              [fontIcon]="isExpanded ? 'expand_less' : 'expand_more'"
            />
          </button>

          <button
            class="p-2 rounded-lg hover:bg-green-50 dark:hover:bg-green-900/30 text-green-600 dark:text-green-400 transition-colors"
            [routerLink]="task.id + '/subtasks'"
            [queryParams]="{ isPrivate: isPrivate }"
            title="View subtasks"
          >
            <mat-icon class="w-5! h-5! text-xl!" fontIcon="list" />
          </button>
          <button
            class="p-2 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/30 text-blue-600 dark:text-blue-400 transition-colors"
            [routerLink]="task.id + '/edit_task'"
            [queryParams]="{ isPrivate: isPrivate }"
            title="Edit task"
          >
            <mat-icon class="w-5! h-5! text-xl!" fontIcon="edit" />
          </button>
          <button
            class="p-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30 text-red-600 dark:text-red-400 transition-colors"
            (click)="deleteTask()"
            title="Delete task"
          >
            <mat-icon class="w-5! h-5! text-xl!" fontIcon="delete" />
          </button>
        </div>
      </div>
    </div>
  </div>
}
